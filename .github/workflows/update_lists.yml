name: Update AI Blocklists
on:
  schedule:
    - cron: '0 12 * * *'  # Daily at 12 PM UTC
  workflow_dispatch:       # Manual trigger option

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for proper git history

      # Step 1: Fetch latest changes
      - name: Sync with remote
        run: |
          git config --global user.name "Automated Updater"
          git config --global user.email "actions@github.com"
          git pull origin main --rebase --autostash

      # Step 2: Discover AI domains
      - name: Fetch AI domains
        run: |
          curl --retry 3 -s "https://crt.sh/?q=%25.ai%25&output=json" | 
            jq -r '.[].name_value' | 
            sed 's/\*\.//g; s/^\.//' |
            grep -iE '\.ai$|ai\-|gpt|llm|model|chatbot' |
            awk 'length($0)>3 && !seen[tolower($0)]++' > new_AI_list.txt

      # Step 3: Generate combined list
      - name: Merge lists
        run: |
          {
            echo "# Manual list - Updated $(date +'%Y-%m-%d')"
            grep -v '^#' manual_block_AI.txt | sed '/^$/d'
            echo ""
            echo "# Auto-discovered list - Generated on $(date +'%Y-%m-%d')"
            [ -s new_AI_list.txt ] && cat new_AI_list.txt || echo "# No new domains found"
          } > combined_AI_list.txt

      # Step 4: Commit and push only if changes exist
      - name: Push updates
        run: |
          git add new_AI_list.txt combined_AI_list.txt
          if ! git diff --quiet; then
            git commit -m "Auto-update: $(date +'%Y-%m-%d')"
            git pull origin main --rebase --autostash
            git push origin main
            echo "Changes pushed successfully"
          else
            echo "No changes to commit"
          fi

